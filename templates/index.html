{% extends "base.html" %}
{% block content %}
<div class="container mt-5">
    <h2 class="mb-4">K-Means Clustering Tool with Interactive Editing</h2>

    <!-- File Upload -->
    <div class="card p-3 mb-3">
        <h5>Upload CSV</h5>
        <form id="uploadForm">
            <input type="file" id="fileInput" accept=".csv" class="form-control mb-2" required>
            <button type="submit" class="btn btn-primary">Upload</button>
        </form>
        <div id="uploadMsg" class="mt-2 text-success"></div>
    </div>

    <!-- Column Selection -->
    <div class="card p-3 mb-3" id="columnCard" style="display:none;">
        <h5>Select Columns</h5>
        <label>X Column:</label>
        <select id="xColumn" class="form-select mb-2"></select>
        <label>Y Column:</label>
        <select id="yColumn" class="form-select mb-2"></select>
        <label>K (1â€“10):</label>
        <input type="number" id="kValue" class="form-control mb-2" value="3" min="1" max="10">
        <label>Initialization:</label>
        <select id="initMethod" class="form-select mb-2">
            <option value="random">Random</option>
            <option value="kmeans++">K-means++</option>
        </select>
        <button class="btn btn-success" onclick="runClustering()">Run Clustering</button>
    </div>

    <!-- Results -->
    <div id="resultsCard" class="card p-3 mb-3" style="display:none;">
        <h5>Results</h5>
        <div class="row">
            <div class="col-md-6">
                <p><strong>Centroids:</strong></p>
                <pre id="centroids"></pre>
            </div>
            <div class="col-md-6">
                <p><strong>SSE:</strong> <span id="sse"></span></p>
                <p><strong>Number of Clusters:</strong> <span id="currentK"></span></p>
            </div>
        </div>

        <!-- Cluster Editing Controls -->
        <div class="card p-3 mb-3" id="editingControls" style="display:none;">
            <h6>ðŸŽ¯ Interactive Cluster Editing</h6>
            
            <!-- Edit Mode Toggle -->
            <div class="mb-3">
                <button id="editModeBtn" class="btn btn-warning" onclick="toggleEditMode()">Enter Edit Mode</button>
                <span id="editModeStatus" class="ms-2"></span>
            </div>

            <!-- Point Editing -->
            <div id="pointEditingSection" style="display:none;">
                <div class="row mb-3">
                    <div class="col-md-12">
                        <label class="form-label"><strong>Select Target Cluster:</strong></label>
                        <div id="clusterButtons" class="d-flex flex-wrap gap-2 mt-2"></div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="row mb-3">
                    <div class="col-md-12">
                        <h6>Advanced Operations:</h6>
                        <button class="btn btn-info btn-sm me-2" onclick="showMergeDialog()">Merge Clusters</button>
                        <button class="btn btn-success btn-sm me-2" onclick="showSplitDialog()">Split Cluster</button>
                        <button class="btn btn-secondary btn-sm me-2" onclick="undoLastEdit()">â†¶ Undo</button>
                        <button class="btn btn-outline-danger btn-sm" onclick="resetAllEdits()">Reset All Edits</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Animation Controls -->
        <div class="mb-3">
            <h6>Animation Controls</h6>
            <button id="playBtn" class="btn btn-primary me-2" onclick="playAnimation()">Play Animation</button>
            <button id="pauseBtn" class="btn btn-warning me-2" onclick="pauseAnimation()" disabled>Pause</button>
            <button id="resetBtn" class="btn btn-secondary me-2" onclick="resetAnimation()">Reset</button>
            <label class="me-2">Speed:</label>
            <input type="range" id="speedControl" min="500" max="3000" value="1500" class="form-range" style="width:150px; display:inline-block;">
            <span class="ms-2">Step: <span id="currentStep">0</span> / <span id="totalSteps">0</span></span>
        </div>

        <div class="row">
            <div class="col-md-6">
                <h6>Cluster Plot</h6>
                <canvas id="clusterPlot" style="cursor: default;"></canvas>
            </div>
            <div class="col-md-6">
                <h6>Elbow Method</h6>
                <canvas id="elbowPlot"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Merge Dialog Modal -->
<div class="modal fade" id="mergeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Merge Clusters</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <label>Merge Cluster:</label>
                <select id="mergeCluster1" class="form-select mb-2"></select>
                <label>Into Cluster:</label>
                <select id="mergeCluster2" class="form-select mb-2"></select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="executeMerge()">Merge</button>
            </div>
        </div>
    </div>
</div>

<!-- Split Dialog Modal -->
<div class="modal fade" id="splitModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Split Cluster</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <label>Select Cluster to Split:</label>
                <select id="splitCluster" class="form-select mb-2"></select>
                <small class="text-muted">The selected cluster will be split into two clusters using k-means.</small>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="executeSplit()">Split</button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Our JavaScript -->
<script src="{{ url_for('static', filename='js/app.js') }}"></script>
{% endblock %}